

# 安装 resin

DEBIAN_FRONTEND=noninteractive 

apt install -y default-jdk gcc make libssl-dev

wget -O resin-4.0.66.tar.gz https://caucho.com/download/resin-4.0.66.tar.gz

tar --overwrite -xvzf resin-4.0.66.tar.gz

cd resin-4.0.66 && ./configure && make && make install

if [ "`grep ^web_admin_enable /etc/resin/resin.properties`" == "" ]; then echo "web_admin_enable : false" >> /etc/resin/resin.properties; else sed -i "s/^web_admin_enable.*$/web_admin_enable : false/g" /etc/resin/resin.properties; fi

if [ "`grep ^resin_doc /etc/resin/resin.properties`" == "" ]; then echo "resin_doc : false" >> /etc/resin/resin.properties; else sed -i "s/^resin_doc.*$/resin_doc : false/g" /etc/resin/resin.properties; fi

if [ "`grep ^app.http /etc/resin/resin.properties`" == "" ]; then echo "app.http : 80" >> /etc/resin/resin.properties; else sed -i "s/^app.http.*$/app.http : 80/g" /etc/resin/resin.properties; fi

if [ "`grep ^web.http /etc/resin/resin.properties`" == "" ]; then echo "web.http : 80" >> /etc/resin/resin.properties; else sed -i "s/^web.http.*$/web.http : 80/g" /etc/resin/resin.properties; fi

systemctl enable resin


# 启动 resin

systemctl start resin


# 停止 resin

systemctl stop resin


# 从第一个节点同步 /var/resin/webapps/ROOT 目录到全部集群节点

for ((i=102; i<201; i++)); do echo; echo sync 192.168.1.${i} ......; echo; rsync -avzh  --exclude=ROOT/WEB-INF/tmp/ --exclude=ROOT/WEB-INF/work/ /var/resin/webapps/ROOT 192.168.1.${i}://var/resin/webapps/; echo; done


# 高并发高可用负载均衡

apt install -y nginx

if [ "`grep '#include \/etc\/nginx\/sites-enabled\/' /etc/nginx/nginx.conf`" == "" ]; then echo ok; sed -i "s/include \/etc\/nginx\/sites-enabled\//#include \/etc\/nginx\/sites-enabled\//g" /etc/nginx/nginx.conf; fi

# vi /etc/nginx/conf.d/winter.conf

    upstream winter {

        ip_hash;

        server 192.168.1.101;
        server 192.168.1.102;
        server 192.168.1.103;
        server 192.168.1.104;
        server 192.168.1.105;
        server 192.168.1.106;
        server 192.168.1.107;
        server 192.168.1.108;
        server 192.168.1.109;
        server 192.168.1.110;
        server 192.168.1.111;
        server 192.168.1.112;
        server 192.168.1.113;
        server 192.168.1.114;
        server 192.168.1.115;
        server 192.168.1.116;
        server 192.168.1.117;
        server 192.168.1.118;
        server 192.168.1.119;
        server 192.168.1.120;
        server 192.168.1.121;
        server 192.168.1.122;
        server 192.168.1.123;
        server 192.168.1.124;
        server 192.168.1.125;
        server 192.168.1.126;
        server 192.168.1.127;
        server 192.168.1.128;
        server 192.168.1.129;
        server 192.168.1.130;
        server 192.168.1.131;
        server 192.168.1.132;
        server 192.168.1.133;
        server 192.168.1.134;
        server 192.168.1.135;
        server 192.168.1.136;
        server 192.168.1.137;
        server 192.168.1.138;
        server 192.168.1.139;
        server 192.168.1.140;
        server 192.168.1.141;
        server 192.168.1.142;
        server 192.168.1.143;
        server 192.168.1.144;
        server 192.168.1.145;
        server 192.168.1.146;
        server 192.168.1.147;
        server 192.168.1.148;
        server 192.168.1.149;
        server 192.168.1.150;
        server 192.168.1.151;
        server 192.168.1.152;
        server 192.168.1.153;
        server 192.168.1.154;
        server 192.168.1.155;
        server 192.168.1.156;
        server 192.168.1.157;
        server 192.168.1.158;
        server 192.168.1.159;
        server 192.168.1.160;
        server 192.168.1.161;
        server 192.168.1.162;
        server 192.168.1.163;
        server 192.168.1.164;
        server 192.168.1.165;
        server 192.168.1.166;
        server 192.168.1.167;
        server 192.168.1.168;
        server 192.168.1.169;
        server 192.168.1.170;
        server 192.168.1.171;
        server 192.168.1.172;
        server 192.168.1.173;
        server 192.168.1.174;
        server 192.168.1.175;
        server 192.168.1.176;
        server 192.168.1.177;
        server 192.168.1.178;
        server 192.168.1.179;
        server 192.168.1.180;
        server 192.168.1.181;
        server 192.168.1.182;
        server 192.168.1.183;
        server 192.168.1.184;
        server 192.168.1.185;
        server 192.168.1.186;
        server 192.168.1.187;
        server 192.168.1.188;
        server 192.168.1.189;
        server 192.168.1.190;
        server 192.168.1.191;
        server 192.168.1.192;
        server 192.168.1.193;
        server 192.168.1.194;
        server 192.168.1.195;
        server 192.168.1.196;
        server 192.168.1.197;
        server 192.168.1.198;
        server 192.168.1.199;
        server 192.168.1.200;

    }

    server {

        listen 80;

        location / {

                proxy_pass http://winter;

        }

    }


# 重启 nginx

# systemctl restart nginx


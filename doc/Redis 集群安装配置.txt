
# 共 9 个节点，3 主 6 从

# 在每一个节点执行

apt install -y redis

if [ "`grep ^bind /etc/redis/redis.conf`" == "" ]; then echo "bind 0.0.0.0" >> /etc/redis/redis.conf; else sed -i "s/^bind.*$/bind 0.0.0.0/g" /etc/redis/redis.conf; fi

if [ "`grep ^cluster-enabled /etc/redis/redis.conf`" == "" ]; then echo "cluster-enabled yes" >> /etc/redis/redis.conf; else sed -i "s/^cluster-enabled.*$/cluster-enabled yes/g" /etc/redis/redis.conf; fi

if [ "`grep ^cluster-node-timeout /etc/redis/redis.conf`" == "" ]; then echo "cluster-node-timeout 5000" >> /etc/redis/redis.conf; else sed -i "s/^cluster-node-timeout.*$/cluster-node-timeout 5000/g" /etc/redis/redis.conf; fi

if [ "`grep ^appendonly /etc/redis/redis.conf`" == "" ]; then echo "appendonly yes" >> /etc/redis/redis.conf; else sed -i "s/^appendonly.*$/appendonly yes/g" /etc/redis/redis.conf; fi

if [ "`grep ^cluster-config-file /etc/redis/redis.conf`" == "" ]; then echo "cluster-config-file nodes-6379.conf" >> /etc/redis/redis.conf; else sed -i "s/^cluster-config-file.*$/cluster-config-file nodes-6379.conf/g" /etc/redis/redis.conf; fi

systemctl restart redis


# 在第一个节点执行

redis-cli --cluster create 192.168.1.241:6379 192.168.1.242:6379 192.168.1.243:6379 192.168.1.244:6379 192.168.1.245:6379 192.168.1.246:6379 192.168.1.247:6379 192.168.1.248:6379 192.168.1.249:6379 --cluster-replicas 2


# 高可用负载均衡

# apt install haproxy -y

# vi /etc/haproxy/haproxy.cfg

listen winter_redis_cluster

	mode tcp
	balance source
	bind 0.0.0.0:6379
	
	server redis1 192.168.1.201:6379
	server redis2 192.168.1.242:6379
	server redis3 192.168.1.243:6379

# systemctl enable haproxy

# systemctl restart haproxy


# 在第一个节点重启所有节点

for ((i=9; i>0; i--)); do ssh 192.168.1.24$i "sync && reboot" ; done


# 在第一个节点关闭所有节点

for ((i=9; i>0; i--)); do ssh 192.168.1.24$i "sync && halt -p" ; done

